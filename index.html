<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPC_SIM // NEBULA_OS</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@300;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* --- NEBULA THEME VARIABLES --- */
        :root {
            /* Critical Fix: Tells browser to render native controls in dark mode */
            color-scheme: dark;

            /* Backgrounds */
            --bg-void: #030014;
            --bg-glass: rgba(20, 20, 35, 0.6);
            --bg-glass-hover: rgba(255, 255, 255, 0.07);
            
            /* Accents */
            --accent-primary: #8b5cf6; /* Violet */
            --accent-secondary: #06b6d4; /* Cyan */
            --accent-root: #f43f5e; /* Rose */
            --accent-user: #f59e0b; /* Amber */
            --accent-guest: #10b981; /* Emerald */
            
            /* Borders & Glows */
            --border-light: rgba(255, 255, 255, 0.15);
            --glow-primary: 0 0 20px rgba(139, 92, 246, 0.3);
            
            /* Text */
            --text-main: #f8fafc;
            --text-muted: #94a3b8;

            --font-display: 'Space Grotesk', sans-serif;
            --font-body: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; user-select: none; outline: none; }

        body {
            margin: 0; padding: 20px;
            background-color: var(--bg-void);
            color: var(--text-main);
            font-family: var(--font-body);
            height: 100vh;
            display: flex; flex-direction: column; gap: 24px;
            overflow: hidden;
            background: radial-gradient(circle at 50% 0%, #1e1b4b, #030014 60%);
        }

        /* --- TOP BAR --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-glass);
            backdrop-filter: blur(16px);
            border: 1px solid var(--border-light);
            padding: 12px 24px;
            border-radius: 16px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
            z-index: 100;
            margin: 0 20px;
        }

        .brand {
            font-family: var(--font-display);
            font-weight: 700; font-size: 20px;
            letter-spacing: -0.5px;
            display: flex; align-items: center; gap: 10px;
        }
        .brand-icon {
            width: 24px; height: 24px;
            background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary));
            border-radius: 6px;
            box-shadow: var(--glow-primary);
        }

        .controls { display: flex; gap: 8px; }

        .btn-icon {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-light);
            color: var(--text-muted);
            width: 36px; height: 36px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; cursor: pointer;
            transition: all 0.2s;
        }
        .btn-icon:hover {
            background: var(--bg-glass-hover);
            color: var(--text-main);
            border-color: var(--text-main);
            transform: translateY(-2px);
        }

        .btn-reset {
            background: rgba(244, 63, 94, 0.15);
            border: 1px solid rgba(244, 63, 94, 0.3);
            color: var(--accent-root);
            padding: 0 16px; height: 36px;
            border-radius: 8px;
            font-family: var(--font-code); font-size: 11px; font-weight: 700;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-reset:hover {
            background: var(--accent-root); color: white;
            box-shadow: 0 0 15px rgba(244, 63, 94, 0.4);
        }

        /* --- MAIN STAGE --- */
        .layout {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 24px;
            padding: 0 20px;
            height: 100%;
            min-height: 0;
        }

        .kernel-space {
            position: relative;
            background: rgba(10, 10, 20, 0.4);
            border: 1px solid var(--border-light);
            border-radius: 24px;
            overflow: hidden;
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            box-shadow: inset 0 0 80px rgba(0,0,0,0.8);
        }

        #wire-layer { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; }

        /* KERNEL CORE */
        .kernel-node {
            position: absolute; left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            width: 240px; height: 160px;
            
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 0 60px rgba(139, 92, 246, 0.1);
            
            border-radius: 20px;
            z-index: 10;
            display: flex; flex-direction: column; align-items: center;
            padding: 12px;
            transition: transform 0.05s;
        }
        .kernel-header {
            font-family: var(--font-code); font-size: 10px;
            color: var(--accent-primary); letter-spacing: 2px; margin-bottom: 8px;
            text-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }
        .buffer-container {
            width: 100%; flex-grow: 1;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.05);
            overflow-y: auto;
            padding: 6px; display: flex; flex-direction: column; gap: 6px;
        }
        .buffer-container::-webkit-scrollbar { width: 0; }

        .msg-item {
            background: linear-gradient(90deg, rgba(255,255,255,0.05), transparent);
            border-left: 2px solid #fff;
            padding: 8px 10px;
            font-family: var(--font-code); font-size: 10px; color: var(--text-muted);
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 0 4px 4px 0;
            animation: slideIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .msg-payload { color: #fff; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; }
        @keyframes slideIn { from { opacity:0; transform: translateX(-10px); } to { opacity:1; transform: translateX(0); } }

        /* PROCESS NODES */
        .node {
            position: absolute;
            width: 84px; height: 84px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
            border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 5;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.2s;
        }
        .node:hover { transform: scale(1.1); z-index: 20; border-color: var(--text-main); }
        
        .node span { font-family: var(--font-display); font-weight: 500; font-size: 12px; }
        .pid {
            font-family: var(--font-code); font-size: 9px;
            background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 100px;
            margin-top: 4px; color: var(--text-muted);
        }

        .node.root { border-bottom: 2px solid var(--accent-root); }
        .node.user { border-bottom: 2px solid var(--accent-user); }
        .node.guest { border-bottom: 2px solid var(--accent-guest); }

        /* --- SIDEBAR --- */
        .sidebar { display: flex; flex-direction: column; gap: 20px; height: 100%; min-height: 0; }

        .panel {
            background: var(--bg-glass);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .panel-label {
            font-family: var(--font-code); font-size: 10px; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;
            display: block;
        }

        .input-group { display: flex; gap: 8px; margin-bottom: 20px; }
        
        /* --- DROPDOWN FIXES --- */
        select, input[type="text"] {
            flex-grow: 1;
            background: #0f172a; /* Solid dark background */
            border: 1px solid var(--border-light);
            color: var(--text-main);
            padding: 10px; border-radius: 10px;
            font-family: var(--font-body); font-size: 12px;
            cursor: pointer; transition: 0.2s;
            appearance: none; /* Removes default arrow */
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2394a3b8%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 12px top 50%;
            background-size: 8px auto;
        }
        select:hover, input:hover { border-color: var(--accent-primary); }
        select:focus, input:focus { border-color: var(--accent-primary); outline: none; }
        
        /* Specific fix for options */
        select option {
            background-color: #0f172a;
            color: var(--text-main);
            padding: 10px;
        }

        .btn-add {
            width: 40px; background: var(--text-main); color: black;
            border: none; border-radius: 10px; font-size: 20px; cursor: pointer;
            transition: 0.2s;
        }
        .btn-add:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255,255,255,0.3); }

        .routing-grid {
            display: flex; flex-direction: column; gap: 12px;
            background: rgba(0,0,0,0.2); padding: 16px; border-radius: 16px;
            border: 1px solid var(--border-light);
        }

        .btn-action {
            width: 100%; padding: 12px; border-radius: 10px;
            font-family: var(--font-display); font-weight: 600; font-size: 13px;
            cursor: pointer; border: none; transition: 0.2s;
        }
        .btn-send {
            background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary));
            color: white; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        .btn-send:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(139, 92, 246, 0.5); }
        
        .btn-read {
            background: rgba(255,255,255,0.05);
            color: var(--text-main); border: 1px solid var(--border-light);
        }
        .btn-read:hover { background: rgba(255,255,255,0.1); }

        /* TERMINAL */
        .terminal {
            flex-grow: 1;
            background: #000;
            border: 1px solid var(--border-light);
            border-radius: 20px;
            padding: 16px;
            font-family: var(--font-code); font-size: 11px;
            overflow-y: auto; min-height: 0;
            box-shadow: inset 0 0 20px rgba(255,255,255,0.05);
        }
        .log-entry { margin-bottom: 6px; opacity: 0.8; }
        .log-time { color: var(--text-muted); margin-right: 8px; opacity: 0.5; }
        .log-sys { color: var(--accent-primary); }
        .log-err { color: var(--accent-root); }
        .log-ok { color: var(--accent-guest); }

        /* --- ANIMATIONS --- */
        .packet {
            position: absolute; width: 12px; height: 12px;
            background: #fff; border-radius: 50%;
            box-shadow: 0 0 15px #fff, 0 0 30px var(--accent-primary);
            z-index: 100;
        }
        .packet-label {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); padding: 4px 8px; border-radius: 4px;
            font-size: 10px; white-space: nowrap; color: var(--accent-secondary);
            border: 1px solid var(--accent-secondary); font-family: var(--font-code);
        }

        .overlay-icon {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            font-size: 60px; z-index: 200; pointer-events: none;
            filter: drop-shadow(0 0 20px rgba(0,0,0,0.8));
            animation: popFade 0.8s forwards;
        }
        @keyframes popFade {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            40% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -60%) scale(1); opacity: 0; }
        }
        
        .legend {
            position: absolute; bottom: 20px; left: 20px;
            display: flex; gap: 16px;
            font-family: var(--font-code); font-size: 10px; color: var(--text-muted);
            background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 100px;
            border: 1px solid var(--border-light); pointer-events: none;
        }
        .dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 4px; }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <div class="brand-icon"></div>
            Message Passing IPC
        </div>
        <div class="controls">
            <button class="btn-icon" onclick="sim.undo()" title="Undo (Ctrl+Z)">‚éå</button>
            <button class="btn-icon" onclick="sim.redo()" title="Redo (Ctrl+Y)">‚Üª</button>
            <div style="width:1px; background:var(--border-light); margin: 0 8px;"></div>
            <button class="btn-reset" onclick="sim.reset()">SYSTEM REBOOT</button>
        </div>
    </header>

    <div class="layout">
        <div class="kernel-space" id="kernelSpace">
            <canvas id="wire-layer"></canvas>
            
            <div class="kernel-node" id="kernelNode">
                <div class="kernel-header">KERNEL BUFFER</div>
                <div class="buffer-container" id="bufferContainer"></div>
            </div>

            <div class="legend">
                <span><span class="dot" style="background:var(--accent-root)"></span>ROOT</span>
                <span><span class="dot" style="background:var(--accent-user)"></span>USER</span>
                <span><span class="dot" style="background:var(--accent-guest)"></span>GUEST</span>
            </div>
        </div>

        <aside class="sidebar">
            <div class="panel">
                <span class="panel-label">Process Manager</span>
                <div class="input-group">
                    <select id="spawnType">
                        <option value="root">ROOT (Admin)</option>
                        <option value="user">USER (Standard)</option>
                        <option value="guest">GUEST (Restricted)</option>
                    </select>
                    <button class="btn-add" onclick="sim.spawn()">+</button>
                </div>

                <div class="routing-grid">
                    <span class="panel-label" style="margin:0">Message Routing</span>
                    
                    <select id="senderSelect"><option>Select Sender...</option></select>
                    
                    <div style="text-align:center; color:var(--border-light); font-size:10px;">‚ñº</div>
                    
                    <select id="receiverSelect"><option>Select Receiver...</option></select>

                    <!-- NEW FEATURE: PAYLOAD INPUT -->
                    <div style="margin-top:4px;">
                        <input type="text" id="payloadInput" placeholder="Data Payload (e.g., 0xAF3, HELLO)" style="width:100%; font-family:var(--font-code);">
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">
                        <button class="btn-action btn-send" onclick="sim.send()">TRANSMIT</button>
                        <button class="btn-action btn-read" onclick="sim.read()">RECEIVE</button>
                    </div>
                </div>
            </div>

            <div class="terminal" id="terminal">
                <div class="log-entry log-sys"><span class="log-time">[INIT]</span> Nebula Kernel v2.0 Loaded...</div>
            </div>
        </aside>
    </div>

    <script>
        class Sim {
            constructor() {
                this.procs = [];
                this.buffer = [];
                this.pid = 100;
                this.history = [];
                this.future = [];

                this.space = document.getElementById('kernelSpace');
                this.kernel = document.getElementById('kernelNode');
                this.bufUI = document.getElementById('bufferContainer');
                this.canvas = document.getElementById('wire-layer');
                this.ctx = this.canvas.getContext('2d');
                this.term = document.getElementById('terminal');

                window.addEventListener('resize', () => this.resize());
                
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'z') { e.preventDefault(); this.undo(); }
                        if (e.key === 'y') { e.preventDefault(); this.redo(); }
                    }
                });

                // Initialize Permanent Processes
                this.spawn('root', 'SYS_ROOT', false);
                this.spawn('user', 'SYS_USER', false);
                this.spawn('guest', 'SYS_GUEST', false);
                this.saveState(); // Base State

                this.resize();
                this.loop();
            }

            // --- STATE ---
            snapshot() {
                return {
                    processes: this.procs.map(p => ({...p, el: null})),
                    buffer: JSON.parse(JSON.stringify(this.buffer)),
                    pid: this.pid,
                    logHTML: this.term.innerHTML
                };
            }

            saveState() {
                this.history.push(this.snapshot());
                this.future = [];
                if(this.history.length > 50) this.history.shift();
            }

            restore(state) {
                this.pid = state.pid;
                this.buffer = state.buffer;
                this.term.innerHTML = state.logHTML;
                this.term.scrollTop = this.term.scrollHeight;

                this.procs.forEach(p => p.el && p.el.remove());
                this.procs = state.processes.map(data => {
                    const el = document.createElement('div');
                    el.className = `node ${data.type}`;
                    el.innerHTML = `<span>${data.name}</span><div class="pid">PID:${data.id}</div>`;
                    this.space.appendChild(el);
                    return { ...data, el: el };
                });

                this.placeNodes();
                this.renderBuf();
                this.updateUI();
            }

            undo() {
                if(this.history.length <= 1) return;
                const curr = this.history.pop();
                this.future.push(curr);
                this.restore(this.history[this.history.length - 1]);
            }

            redo() {
                if(this.future.length === 0) return;
                const next = this.future.pop();
                this.history.push(next);
                this.restore(next);
            }

            // --- LOGIC ---
            spawn(type, name, save = true) {
                if(save) this.saveState();
                const t = type || document.getElementById('spawnType').value;
                const n = name || `${t.toUpperCase()}_${this.pid}`;
                const p = { id: this.pid++, name: n, type: t, el: null, x:0, y:0 };
                
                const el = document.createElement('div');
                el.className = `node ${t}`;
                el.innerHTML = `<span>${n}</span><div class="pid">PID:${p.id}</div>`;
                this.space.appendChild(el);
                p.el = el;
                
                this.procs.push(p);
                this.placeNodes();
                this.updateUI();
                this.log(`Spawned Process: ${n}`, 'sys');
            }

            placeNodes() {
                const cx = this.space.clientWidth / 2;
                const cy = this.space.clientHeight / 2;
                const r = 260; // Wider radius for breathing room
                
                this.procs.forEach((p, i) => {
                    const count = this.procs.length;
                    const angle = Math.PI + (Math.PI * (i + 1) / (count + 1));
                    p.x = cx + Math.cos(angle) * r - 42; // centered
                    p.y = cy + Math.sin(angle) * r * 0.6 - 42;
                    
                    if(p.el) {
                        p.el.style.left = `${p.x}px`;
                        p.el.style.top = `${p.y}px`;
                    }
                });
            }

            check(s, r) {
                if(s.id === r.id) return "Loopback Error";
                if(s.type === 'root') return true;
                if(s.type === 'guest') return r.type === 'guest' ? true : "Guest Restricted";
                if(s.type === 'user') return r.type === 'root' ? "Root Protected" : true;
                return true;
            }

            send() {
                const sId = parseInt(document.getElementById('senderSelect').value);
                const rId = parseInt(document.getElementById('receiverSelect').value);
                let payload = document.getElementById('payloadInput').value.trim();
                if(!payload) payload = "DATA"; // Default payload if empty

                if(!sId || !rId) return;

                const s = this.procs.find(p => p.id === sId);
                const r = this.procs.find(p => p.id === rId);

                if(s.id === r.id) { this.err('‚õî', 'Loopback blocked'); return; }

                this.anim(s, 'kernel', payload, () => {
                    const res = this.check(s, r);
                    if(res === true) {
                        this.saveState();
                        this.buffer.push({from:sId, to:rId, payload: payload});
                        this.renderBuf();
                        this.log(`Buffered [${payload}] for ${r.name}`, 'ok');
                    } else {
                        this.err('‚õî', `Blocked: ${res}`);
                    }
                });
            }

            read() {
                const sId = parseInt(document.getElementById('senderSelect').value);
                const rId = parseInt(document.getElementById('receiverSelect').value);
                if(!sId || !rId) return;

                if(sId === rId) { this.err('‚õî', 'Loopback blocked'); return; }

                const r = this.procs.find(p => p.id === rId);
                const idx = this.buffer.findIndex(m => m.to === rId && m.from === sId);

                if(idx === -1) { this.err('üì≠', 'Buffer Empty / No Msg'); return; }

                // Get payload before removing
                const msg = this.buffer[idx];
                
                this.saveState();
                this.buffer.splice(idx, 1);
                this.renderBuf();
                
                this.anim('kernel', r, msg.payload, () => {
                    this.log(`Received [${msg.payload}] by ${r.name}`, 'ok');
                });
            }

            err(icon, msg) {
                const el = document.createElement('div');
                el.className = 'overlay-icon';
                el.innerHTML = icon;
                this.space.appendChild(el);
                setTimeout(() => el.remove(), 1000);
                this.log(msg, 'err');
                
                // Premium Shake
                let i = 0;
                const shake = setInterval(() => {
                    const off = (i++ % 2 === 0 ? 4 : -4);
                    this.kernel.style.transform = `translate(calc(-50% + ${off}px), -50%)`;
                    if(i > 6) {
                        clearInterval(shake);
                        this.kernel.style.transform = `translate(-50%, -50%)`;
                    }
                }, 30);
            }

            renderBuf() {
                this.bufUI.innerHTML = '';
                if(this.buffer.length === 0) return;
                
                this.buffer.forEach(m => {
                    const s = this.procs.find(p => p.id === m.from);
                    const r = this.procs.find(p => p.id === m.to);
                    if(s && r) {
                        const d = document.createElement('div');
                        d.className = 'msg-item';
                        const color = r.type==='root'?'var(--accent-root)':r.type==='user'?'var(--accent-user)':'var(--accent-guest)';
                        d.style.borderLeftColor = color;
                        d.innerHTML = `<span>${s.name}</span><span>‚ûù</span><span class="msg-payload">${m.payload}</span><span>${r.name}</span>`;
                        this.bufUI.appendChild(d);
                    }
                });
            }

            anim(from, to, text, cb) {
                const start = this.getPos(from);
                const end = this.getPos(to);
                
                const p = document.createElement('div');
                p.className = 'packet';
                // Truncate text if too long for animation
                const displayText = text.length > 8 ? text.substring(0,6)+'..' : text;
                p.innerHTML = `<div class="packet-label">${displayText}</div>`;
                this.space.appendChild(p);

                const t0 = performance.now();
                const step = (now) => {
                    const prog = Math.min((now - t0) / 800, 1);
                    const ease = prog < .5 ? 2 * prog * prog : -1 + (4 - 2 * prog) * prog;
                    
                    const x = start.x + (end.x - start.x) * ease;
                    const y = start.y + (end.y - start.y) * ease;
                    
                    p.style.left = (x - 6) + 'px'; // center 12px
                    p.style.top = (y - 6) + 'px';

                    if(prog < 1) requestAnimationFrame(step);
                    else { p.remove(); if(cb) cb(); }
                };
                requestAnimationFrame(step);
            }

            getPos(obj) {
                if(obj === 'kernel') {
                    const r = this.kernel.getBoundingClientRect();
                    const s = this.space.getBoundingClientRect();
                    return { x: r.left - s.left + r.width/2, y: r.top - s.top + r.height/2 };
                }
                return { x: obj.x + 42, y: obj.y + 42 };
            }

            loop() {
                this.ctx.clearRect(0,0, this.canvas.width, this.canvas.height);
                const k = this.getPos('kernel');
                
                this.procs.forEach(p => {
                    const pc = this.getPos(p);
                    this.ctx.beginPath();
                    this.ctx.moveTo(k.x, k.y);
                    this.ctx.lineTo(pc.x, pc.y);
                    
                    // Premium Gradient Wire attempt using strokeStyle
                    const grad = this.ctx.createLinearGradient(k.x, k.y, pc.x, pc.y);
                    grad.addColorStop(0, 'rgba(139, 92, 246, 0.5)');
                    grad.addColorStop(1, 'rgba(255,255,255,0.05)');
                    
                    this.ctx.strokeStyle = grad;
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();
                });
                requestAnimationFrame(() => this.loop());
            }

            updateUI() {
                const s = document.getElementById('senderSelect');
                const r = document.getElementById('receiverSelect');
                const sv = s.value, rv = r.value;
                s.innerHTML = ''; r.innerHTML = '';
                
                this.procs.forEach(p => {
                    const opt = `<option value="${p.id}">${p.name}</option>`;
                    s.innerHTML += opt; r.innerHTML += opt;
                });
                if(sv) s.value = sv;
                if(rv) r.value = rv;
            }

            log(msg, type) {
                const c = type==='err'?'log-err':type==='ok'?'log-ok':'log-sys';
                const t = new Date().toLocaleTimeString('en-US',{hour12:false});
                this.term.insertAdjacentHTML('beforeend', `<div class="log-entry ${c}"><span class="log-time">[${t}]</span> ${msg}</div>`);
                this.term.scrollTop = this.term.scrollHeight;
            }

            resize() {
                this.canvas.width = this.space.clientWidth;
                this.canvas.height = this.space.clientHeight;
                this.placeNodes();
            }
            
            reset() { location.reload(); }
        }

        const sim = new Sim();
    </script>
</body>
</html>
